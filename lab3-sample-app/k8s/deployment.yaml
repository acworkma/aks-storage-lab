# AKS Storage Lab - Kubernetes Deployment
# 
# QUICK START: This deployment uses an inline installation approach that installs
# Python packages at pod startup. This means:
# - No need to build/push a Docker image initially
# - Pod startup takes 30-60 seconds (one-time per pod)
# - Perfect for learning and testing the lab
#
# PRODUCTION: For faster startup and production use, build the Docker image from
# app/Dockerfile and update the image reference below. See BUILD.md for details.
#
apiVersion: apps/v1
kind: Deployment
metadata:
  name: aks-storage-app
  labels:
    app: aks-storage-app
spec:
  replicas: 2
  selector:
    matchLabels:
      app: aks-storage-app
  template:
    metadata:
      labels:
        app: aks-storage-app
        azure.workload.identity/use: "true"  # Enable workload identity
    spec:
      serviceAccountName: workload-identity-sa  # Use the service account from Lab 2
      containers:
      - name: app
        # QUICK START OPTION: This uses an inline approach for fast testing without building images
        # Pod startup takes ~30-60 seconds due to package installation
        # For production or faster startup, build and use the Dockerfile in app/ (see BUILD.md)
        # TODO: Build and push the Docker image from app/Dockerfile, then replace with:
        # image: <your-acr-name>.azurecr.io/aks-storage-app:v1
        # and remove the 'command:' section below
        image: python:3.11-slim
        command: 
          - /bin/sh
          - -c
          - |
            pip install --no-cache-dir flask==3.0.0 azure-identity==1.15.0 azure-storage-blob==12.19.0 gunicorn==21.2.0 && \
            cat > /app.py << 'EOF'
            from flask import Flask, jsonify
            from azure.identity import DefaultAzureCredential
            from azure.storage.blob import BlobServiceClient
            import os
            app = Flask(__name__)
            STORAGE_ACCOUNT_NAME = os.getenv('AZURE_STORAGE_ACCOUNT_NAME')
            CONTAINER_NAME = os.getenv('AZURE_STORAGE_CONTAINER_NAME', 'data')
            account_url = f"https://{STORAGE_ACCOUNT_NAME}.blob.core.windows.net"
            credential = DefaultAzureCredential()
            blob_service_client = BlobServiceClient(account_url, credential=credential)
            @app.route('/')
            def home():
                return jsonify({'message': 'AKS Storage Lab App', 'storage_account': STORAGE_ACCOUNT_NAME})
            @app.route('/health')
            def health():
                try:
                    container_client = blob_service_client.get_container_client(CONTAINER_NAME)
                    container_client.get_container_properties()
                    return jsonify({'status': 'healthy', 'storage_account': STORAGE_ACCOUNT_NAME})
                except Exception as e:
                    return jsonify({'status': 'unhealthy', 'error': str(e)}), 500
            @app.route('/list')
            def list_blobs():
                try:
                    container_client = blob_service_client.get_container_client(CONTAINER_NAME)
                    blobs = [{'name': b.name, 'size': b.size} for b in container_client.list_blobs()]
                    return jsonify({'container': CONTAINER_NAME, 'blob_count': len(blobs), 'blobs': blobs})
                except Exception as e:
                    return jsonify({'error': str(e)}), 500
            if __name__ == '__main__':
                app.run(host='0.0.0.0', port=8080)
            EOF
            python /app.py
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 8080
          name: http
        env:
        - name: AZURE_STORAGE_ACCOUNT_NAME
          value: "<your-storage-account-name>"  # REQUIRED: Update with your storage account name
        - name: AZURE_STORAGE_CONTAINER_NAME
          value: "data"
        # These are automatically injected by workload identity
        # - AZURE_CLIENT_ID
        # - AZURE_TENANT_ID
        # - AZURE_FEDERATED_TOKEN_FILE
        resources:
          requests:
            cpu: 100m
            memory: 128Mi
          limits:
            cpu: 500m
            memory: 512Mi
        livenessProbe:
          httpGet:
            path: /health
            port: 8080
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3
        readinessProbe:
          httpGet:
            path: /health
            port: 8080
          initialDelaySeconds: 10
          periodSeconds: 5
          timeoutSeconds: 3
          failureThreshold: 3
